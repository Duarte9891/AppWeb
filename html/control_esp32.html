<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Control GOKART MGK100</title>
  <style>
    body {
      background-color: #454362;
      font-family: Arial, sans-serif;
      max-width: 500px;
      margin: auto;
      padding: 20px;
      border-radius: 12px;
    }

    input,
    button,
    select {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
    }

    label {
      margin-top: 12px;
      display: block;
    }

    .switch {
      display: flex;
      align-items: center;
      margin-top: 8px;
    }

    .switch input {
      margin-right: 10px;
      transform: scale(1.2);
    }

    .titulo {
      color: #2c2c2c;
      font-weight: bold;
      margin-top: 20px;
      font-size: 30px;
      background-color: rgb(228, 228, 228);
      height: 80px;

      text-align: center;
      text-shadow: #55626b;
      /* âœ… Centra horizontalmente el texto */
      display: block;
      /* Asegura que se comporte como bloque */
      width: 100%;
      /* Ocupa todo el ancho disponible */

    }

    #estado {
      font-weight: bold;
      margin-top: 20px;
      font-size: 30px;
      background-color: rgb(149, 201, 168);
      background-size: 60px;

      text-align: center;
      /* âœ… Centra horizontalmente el texto */
      display: block;
      /* Asegura que se comporte como bloque */
      width: 100%;
      /* Ocupa todo el ancho disponible */
    }

    #emergencia {
      background-color: #c62828;
      color: white;
      font-weight: bold;
    }
  </style>
</head>

<body>


  <div class="titulo">

    <label>Control de GOKART MGK100</label>

  </div>




  <p id="estado">Desconectado</p>

  <label>Selecciona GOKART:</label>
  <select id="lista_gokarts" onchange="seleccionarGokart()">
    <option disabled selected>-- Selecciona uno --</option>
  </select>

  <label>Nombre nuevo:</label>
  <input id="nuevo_nombre" type="text" placeholder="Ej: Gokart3" />

  <label>IP nueva:</label>
  <input id="nueva_ip" type="text" placeholder="Ej: 192.168.1.105" />

  <button onclick="agregarGokart()">âž• Guardar nuevo GOKART</button>

  <hr>

  <label>Velocidad mÃ¡xima frente:</label>
  <input id="vel_frente" type="number" min="0" max="100" value="50">

  <label>Velocidad mÃ¡xima reversa:</label>
  <input id="vel_reversa" type="number" min="0" max="100" value="30">

  <label>Tiempo de activaciÃ³n (seg):</label>
  <input id="tiempo" type="number" min="0" value="60">

  <div class="switch">
    <input id="encendido" type="checkbox">
    <label for="encendido">Encendido</label>
  </div>

  <div class="switch">
    <input id="iluminacion" type="checkbox">
    <label for="iluminacion">IluminaciÃ³n</label>
  </div>

  <button onclick="enviarDatos()">Enviar al GOKART</button>
  <button id="emergencia" onclick="enviarEmergencia()">â›” Paro de Emergencia</button>



  <script>
    let socket = null;
    let conectarTimeout = null;
    const estado = document.getElementById("estado");

    function cargarGokarts() {
      const lista = document.getElementById("lista_gokarts");
      lista.innerHTML = `<option disabled selected>-- Selecciona uno --</option>`;
      const datos = JSON.parse(localStorage.getItem("gokarts") || "{}");
      for (const nombre in datos) {
        const opt = document.createElement("option");
        opt.value = datos[nombre];
        opt.textContent = nombre;
        lista.appendChild(opt);
      }
    }

    function agregarGokart() {
      const nombre = document.getElementById("nuevo_nombre").value.trim();
      const ip = document.getElementById("nueva_ip").value.trim();
      if (!nombre || !ip) return alert("Completa ambos campos");
      const datos = JSON.parse(localStorage.getItem("gokarts") || "{}");
      datos[nombre] = ip;
      localStorage.setItem("gokarts", JSON.stringify(datos));
      cargarGokarts();
      alert("âœ… GOKART guardado");
      document.getElementById("nuevo_nombre").value = "";
      document.getElementById("nueva_ip").value = "";
    }

    function seleccionarGokart() {
      clearTimeout(conectarTimeout);  // Detener conexiÃ³n previa si hay
      const lista = document.getElementById("lista_gokarts");
      const ip = lista.value;
      const nombre = lista.options[lista.selectedIndex].text;

      if (!ip) return;

      estado.textContent = `â³ Conectando a ${nombre} (${ip}) en 3 segundos...`;
      estado.style.color = "blue";

      conectarTimeout = setTimeout(() => {
        conectarWebSocket(ip, nombre);
      }, 3000);
    }

    function conectarWebSocket(ip, nombre) {
      socket = new WebSocket("ws://" + ip + "/ws");

      socket.onopen = () => {
        estado.textContent = `âœ… Conectado a ${nombre} (${ip})`;
        estado.style.color = "green";
      };
      socket.onclose = () => {
        estado.textContent = "ðŸ”Œ ConexiÃ³n cerrada";
        estado.style.color = "gray";
      };
      socket.onerror = () => {
        estado.textContent = "âŒ Error de conexiÃ³n";
        estado.style.color = "red";
      };
      socket.onmessage = (e) => {
        console.log("ðŸ“¨ Respuesta:", e.data);
        estado.textContent = "âœ… Respuesta: " + e.data;
      };
    }

    function enviarDatos() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert("WebSocket no estÃ¡ conectado.");
        return;
      }

      const lista = document.getElementById("lista_gokarts");
      const nombreSeleccionado = lista.options[lista.selectedIndex].text;

      const datos = {
        nombre_gokart: nombreSeleccionado,
        velocidad_frente: parseInt(document.getElementById("vel_frente").value),
        velocidad_reversa: parseInt(document.getElementById("vel_reversa").value),
        tiempo_activacion: parseInt(document.getElementById("tiempo").value),
        encendido: document.getElementById("encendido").checked,
        iluminacion: document.getElementById("iluminacion").checked
      };

      socket.send(JSON.stringify(datos));
      estado.textContent = "ðŸ“¤ Datos enviados a " + nombreSeleccionado;
    }

    function enviarEmergencia() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert("WebSocket no estÃ¡ conectado.");
        return;
      }

      const lista = document.getElementById("lista_gokarts");
      const nombreSeleccionado = lista.options[lista.selectedIndex].text;

      socket.send(JSON.stringify({
        emergencia: true,
        nombre_gokart: nombreSeleccionado
      }));

      estado.textContent = "ðŸš¨ Paro de emergencia enviado a " + nombreSeleccionado;
    }

    cargarGokarts();
  </script>

</body>

</html>